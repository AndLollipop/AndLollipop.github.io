---
title: Cameraä¹‹[äººè„¸è¯†åˆ«] #æ–‡ç« çš„æ ‡é¢˜
author: èŠ±èŠ±
date: 2018-02-03 17:19 #æ–‡ç« ç”Ÿæˆæ™‚é–“
categories:
- æŠ€æœ¯å‘¨ # è¿™ä¸ªæ˜¯æˆ‘ä»¬çš„è®¡åˆ’èµ·åæŠ€æœ¯å‘¨
- Cameraå¼€å‘ # è¿™ä¸ªæ˜¯æŠ€æœ¯æ‰€å±æ¨¡å—å ä½ ä¹Ÿå¯ä»¥å®šä¹‰å¤šä¸ªç±»åˆ«ï¼Œä½†è‡³å°‘æœ‰ä¸ºä¸¤ä¸ª
tags: Cameraå¼€å‘ # è¿™ä¸ªæ˜¯æ‰€å±çš„Tagä¹Ÿæ˜¯æœ€æ˜¾çœ¼çš„ä½ç½®è¦ä»¥æŠ€æœ¯ç±»åˆ«è¿›è¡Œåˆ’åˆ†
---

### å‰è¨€
&emsp;&emsp;åœ¨ä½¿ç”¨ç›¸æœºæ—¶ï¼Œæˆ‘ä»¬ä¼šå‘ç°å¾ˆå¤šç›¸æœºéƒ½ä¼šæœ‰äººè„¸è¯†åˆ«åŠŸèƒ½ï¼Œå¼€å§‹çš„æ—¶å€™æ„Ÿè§‰å¾ˆå‰å®³ï¼Œåº”è¯¥éœ€è¦äº›å¾ˆå¤šä»£ç æ‰èƒ½å®ç°å§ï¼Œåæ¥æ‰çŸ¥é“google å·²ç»ç»™æˆ‘ä»¬æä¾›äº†äººè„¸è¯†åˆ«çš„æ¥å£ï¼Œä¸Šå±‚åªè¦æ ¹æ®æ¥å£è¿”å›çš„äººè„¸æ•°æ®è¿›è¡Œç»˜åˆ¶äººè„¸è¯†åˆ«æ¡†å°±å¯ä»¥äº†ã€‚

### äººè„¸è¯†åˆ«æ¥å£

FaceDetectionListener æ˜¯google æä¾›çš„ç”¨äºè¿›è¡Œäººè„¸è¯†åˆ«çš„æ¥å£ï¼Œä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼š
> 1. å®ç°æ¥å£
> 2. ä¸ºcamera æ·»åŠ ç›‘å¬
> 3. å¼€å¯äººè„¸ç›‘å¬

```Java
// 1. å®ç°æ¥å£
private class MyFaceDection implements Camera.FaceDetectionListener{
       @Override
       public void onFaceDetection(Camera.Face[] faces, Camera camera) {
       //faces è·å–çš„äººè„¸æ•°æ®
           Log.d(TAG, "onFaceDetection: faces = "+faces.length);
           // è‡ªå®šä¹‰å®ç°çš„ç”¨äºç”»äººè„¸è¯†åˆ«æ¡†çš„ç±»
           if (mFaceView != null){
               mFaceView.setFace(faces);
           }
       }
   }

// 2.è®¾ç½®ç›‘å¬    
mCamera.setFaceDetectionListener(listener);

// 3.å¼€å¯äººè„¸è¯†åˆ«
mCamera.startFaceDetection();
```

 > 4. åœ¨è¦åœæ­¢äººè„¸æ£€æŸ¥æ—¶

```Java
mCamera.setFaceDetectionListener(null);
mCamera.stopFaceDetection();
```
ç»è¿‡ä¸Šé¢ç®€å•çš„å‡ æ­¥å°±å¯ä»¥å®ç°äººè„¸è¯†åˆ«çš„ç›‘å¬å’Œåœæ­¢ç›‘å¬çš„åŠŸèƒ½ã€‚ä½†æ˜¯ç°åœ¨è¿˜ä¸èƒ½å¤ªé«˜å…´ï¼Œå› ä¸ºçœŸæ­£çš„å‘åœ¨åé¢ã€‚

### ä½¿ç”¨äººè„¸è¯†åˆ«çš„æ³¨æ„ç‚¹
1. é¦–å…ˆå¼€å¯äººè„¸è¯†åˆ«ä¸€å®šè¦åœ¨startpreview ä¹‹å
2. æ‰§è¡Œæ‹ç…§å®Œåè¦é‡æ–°è®¾ç½®äººè„¸è¯†åˆ«ç›‘å¬å¹¶å¼€å¯äººè„¸è¯†åˆ«
3. åœ¨æ‰§è¡Œ autoFocus(AutoFocusCallback)(èšç„¦)æ—¶ï¼Œäººè„¸è¯†åˆ«æš‚æ—¶å¤±æ•ˆ
4. åœ¨ä¸€æ¬¡é¢„è§ˆè°ƒç”¨åä¸èƒ½é‡å¤è°ƒç”¨
5. æœ‰äº›è®¾å¤‡ä¸æ”¯æŒäººè„¸è¯†åˆ«ï¼Œè®¾ç½®äººè„¸è¯†åˆ«ç›‘å¬ä¹‹å‰æœ€å¥½æ£€æµ‹æ˜¯å¦æ”¯æŒï¼šå¦‚æœmParameters.getMaxNumDetectedFaces()>0 å³æ”¯æŒäººè„¸è¯†åˆ«

### ç”»äººè„¸è¯†åˆ«æ¡†

è¿”å›çš„äººè„¸æ•°æ®æ‰€åœ¨çš„åæ ‡ç³»å¹¶ä¸æ˜¯æˆ‘ä»¬å±å¹•åæ ‡ç³»ä¸‹çš„æ•°æ®ï¼Œè€Œæ˜¯å¦‚ä¸‹åæ ‡ç³»
![](http://p1chajscf.bkt.clouddn.com/camera-area-coordinates.png)

å·¦ä¸Šè§’çš„åæ ‡æ˜¯(-1000,-1000),é¢„è§ˆç•Œé¢ä¸­å¿ƒç‚¹æ˜¯(0,0)

çŸ¥é“äº†è¿™ä¸ªç‚¹ä¹‹æˆ‘ä»¬å°±å®ç°æ¥å®ç°ç”»äººè„¸è¯†åˆ«æ¡†çš„ç±»

```Java
public class FaceView extends View {
    private static final String TAG = "FaceView";
    private Camera.Face[] mFace;
    private Paint mPaint;
    private MainActivity mActivity;
    private int mDisplayOrientation;
    private int mOrientation;
    private boolean mMirror;
    private Matrix mMatrix = new Matrix();

    public FaceView(Context context, @Nullable AttributeSet attrs) {
        super(context, attrs);
        mActivity = (MainActivity)context;
        mPaint = new Paint();
        mPaint.setAntiAlias(true);
        mPaint.setStyle(Paint.Style.STROKE);
        mPaint.setColor(Color.BLUE);
        mPaint.setStrokeWidth(2);
    }

    public void setFace(Camera.Face[] faces){
        if (faces != null){
            Log.d(TAG, "onFaceDetection: faces = "+faces.length);
        }
        mFace = faces;
        postInvalidate();
    }

    public void clear(){
        mFace = null;
        postInvalidate();
    }

    public void setDisplayOrientation(int orientation){
        mDisplayOrientation = orientation;
    }

    public void setOrientation(int orientation){
        mOrientation = orientation;
        postInvalidate();
    }

    public void setMirror(boolean mirror){
        mMirror = mirror;
    }

    @Override
    protected void onDraw(Canvas canvas) {
      /*rw rh è·å–çš„æ˜¯é¢„è§ˆç•Œé¢çš„å¤§å°ï¼ŒmDisplayOrientation æ˜¯ä¸Šä¸€ç¯‡ä¸­æˆ‘ä»¬ä»‹ç»çš„ ç›¸æœºéœ€è¦æ—‹è½¬ä»¥å®ç°æ­£å¸¸é¢„è§ˆçš„è§’åº¦ï¼ŒmOrientationæ˜¯æ‰‹æœºæ—‹è½¬çš„è§’åº¦ï¼ŒmMirror å‰æ‘„æ˜¯é•œåƒï¼Œåæ‘„éé•œåƒ*/
        if (mFace != null && mFace.length > 0){
            int rw = mActivity.getPreviewWidth();
            int rh = mActivity.getPreviewHeight();

            if (((rh > rw) && ((mDisplayOrientation == 0) || (mDisplayOrientation == 180)))
                    || ((rw > rh) && ((mDisplayOrientation == 90) || (mDisplayOrientation == 270)))) {
                int temp = rw;
                rw = rh;
                rh = temp;
            }
            Log.d(TAG, "onDraw: rw = "+rw+"; rh = "+rh+"; orientation = "+mDisplayOrientation+"; mMirror = "+mMirror);

            // å‡†å¤‡ä½¿è¿”å›çš„äººè„¸åæ ‡å˜æ¢ä¸ºå±å¹•åæ ‡çš„çŸ©é˜µ
            Util.prepareMatrix(mMatrix, mMirror, mDisplayOrientation, rw, rh);

            canvas.save();
            mMatrix.postRotate(mOrientation);
            canvas.rotate(-mOrientation);
            RectF rect = new RectF();
            for (int i = 0; i<mFace.length;i++){
                rect.set(mFace[i].rect);
                mMatrix.mapRect(rect);
                canvas.drawRect(rect, mPaint);
            }
            canvas.restore();
        }
        super.onDraw(canvas);
    }
}
```

å…¶ä¸­ Util.prepareMatrix(mMatrix, mMirror, mDisplayOrientation, rw, rh)çš„å®ç°å¦‚ä¸‹ï¼š

```java
public static void prepareMatrix(Matrix matrix,boolean isMirror,int orientation,int viewWidth,
                              int viewHeight){
        matrix.setScale(isMirror?-1:1,1);
        matrix.postRotate(orientation);

        matrix.postScale(viewWidth / 2000f,viewHeight / 2000f);
        matrix.postTranslate(viewWidth / 2f,viewHeight / 2f);
    }
```
å¥½äº†ï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å°±å¯ä»¥å®ç°äººè„¸è¯†åˆ«åŠŸèƒ½äº†ï¼Œå±•ç¤ºä¸€ä¸‹æ•ˆæœ
![](http://p1chajscf.bkt.clouddn.com/Screenshot_20180203-100742.png)

ğŸ˜‚è™½ç„¶å¾ˆæ¨¡ç³Šï¼Œä½†æ˜¯ä¼°è®¡å¤§å®¶ä¹Ÿèƒ½çœ‹å‡ºæ¥æ˜¯å¸…å¸…çš„é™ˆä¼Ÿéœ†å•¦ï¼Œä½†æ˜¯å¦‚æœçœŸçš„é‡åˆ°äº†è‡ªå·±çš„ç”·ç¥æ‹å‡ºè¿™æ ·çš„ç…§ç‰‡å²‚ä¸è¦æ°”çš„åœ¨åœ°ä¸Šè¸©ä¸¤è„šï¼Œä¸ºäº†è®©æ‰‹æœºå…å—è¿«å®³ï¼Œå°±ä¸‹æ¥çš„ä¸€ç¯‡å°±æ¥å®ç°***èšç„¦*** è®©æˆ‘ä»¬æ‹å‡ºçš„ç”·ç¥æ›´æ¸…æ™°ã€‚
